{% spaceless %}
<!doctype html>
<html>
<head>
{% if env('APP_ENV')!= 'production' %}
	<meta name="robots" content="noindex,nofollow" />
{% endif %}
<title>{% block title %}Food Talk | Find and share Awesome dishes | Dish discovery | Food discovery | Best dishes to eat | Best places to eat | dish reviews {% endblock %}</title>
{% block head %}
<meta charset="utf-8" />
<meta name="copyright" content="Food Talk"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
{% endblock %} 
{% block style %}		
		<!-- bootstrap css -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<!-- raleway font -->
		<link href="https://fonts.googleapis.com/css?family=Raleway:300,400,500,600,700" rel="stylesheet">
		<!-- font awasome -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<!-- custom css -->
		<link rel="stylesheet" href="/assets/css/style.css">
{% endblock %}
		<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

{% block scripts %}
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-75078761-1', 'auto');
	  ga('send', 'pageview');

	</script>
{% endblock %}
<script>
var isLogedin = {% if islogin(0) %}true{% else %}false{% endif %};
var donotloadmore = false;
</script>    
	</head>
	<body>


	<div class="modal fade" id="myModal" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title">Hello</h4>
				</div>
				<div class="modal-body">
					<p>You need to login to continue</p>
				</div>
				<div class="modal-footer">
					<a href="http://foodtalk.in/app/index.html" class="button-getapp">Get App</a>
					<fb:login-button class="login" scope="public_profile,email"
						onlogin="checkLoginState();" size="large"></fb:login-button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>


	<div class="">
{% block header %}
			<nav class="navbar navbar-fixed-top mynav">
				<div class="container padding-left-right-30">

					 <div class="row">
					 	<div class="col-md-2">
					    	<a class="" href="/home">
					            <img alt="Brand" src="/assets/images/logo.png" class="img-responsive logo">
					        </a>
					    </div>
					    <div class="col-md-4 col-md-offset-2">
					    	<div class="search">
	    						<form action="/search" method="get">
					    		<i class="fa fa-search" aria-hidden="true"></i>
	    						<input type="text" name="search" value="{{searchTxt}}" id="name" placeholder="Search dishes, places & people" minlength=2 required="required" />
								<input type="hidden" name="city" value="{{ searchCity ? searchCity : "delhi" }}">
					    		</form>
					    	</div>
					    </div>
					    <div class="col-md-3 col-md-offset-1 button-getapp-parent">
					    
{% if islogin(0) %}
{% set user = islogin(1) %}
					    
					    
					    	<a href="/home" class="menu-after">
					    		<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="22.992px" height="22.17px" viewBox="0 0 22.992 22.17" enable-background="new 0 0 22.992 22.17" xml:space="preserve">
									<path fill="#8c8c8c" d="M22.992,10.746l-1.305,1.412L11.496,2.631L1.304,12.144L0,10.731L11.496,0L22.992,10.746L22.992,10.746z
									 M19.16,12.432l-1.917,9.738H5.748l-1.916-9.738l7.664-7.176L19.16,12.432L19.16,12.432z M12.454,18.314
									c0-0.533-0.43-0.965-0.958-0.965s-0.958,0.432-0.958,0.965c0,0.531,0.43,0.963,0.958,0.963S12.454,18.846,12.454,18.314
									L12.454,18.314z M13.413,13.495c0-1.065-0.858-1.928-1.917-1.928c-1.058,0-1.916,0.862-1.916,1.928c0,1.064,0.858,1.927,1.916,1.927
									C12.554,15.422,13.413,14.559,13.413,13.495L13.413,13.495z"></path>
								</svg>
					    	</a>
					    	
					    	<a href="/store" class="menu-after">
					    		<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="19.875px" height="22px" viewBox="0 0 19.875 22" enable-background="new 0 0 19.875 22" xml:space="preserve">
									<path fill="#8C8C8C" d="M18.267,6.013h-2.455V5.864C15.81,2.633,13.176,0,9.938,0c-3.24,0-5.873,2.633-5.873,5.864v0.148H1.609
									L0.173,22h19.529L18.267,6.013L18.267,6.013z M9.938,0.719c2.14,0,3.981,1.314,4.759,3.174c-1.028-1.535-2.773-2.549-4.759-2.549
									c-1.982,0-3.73,1.014-4.759,2.553C5.959,2.034,7.799,0.719,9.938,0.719z M5.153,6.013C5.632,3.813,7.597,2.16,9.94,2.16
									c2.347,0,4.307,1.652,4.788,3.853H5.153z"></path>
								</svg>
					    	</a>
					    	<a href="/{{user.userName}}" class="menu-after active">
					    		<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="20.397px" height="22px" viewBox="0 0 20.397 22" enable-background="new 0 0 20.397 22" xml:space="preserve">
									<g>
										<path fill="none" d="M20.398,17.652c0-3.442-4.446-6.232-10.088-6.232c-5.641,0-10.214,2.791-10.214,6.232"></path>
										<path fill="#8C8C8C" d="M10.311,11.425c3.103,0,5.618-2.558,5.618-5.712S13.413,0,10.311,0S4.693,2.558,4.693,5.712
											S7.208,11.425,10.311,11.425L10.311,11.425z"></path>
										<path fill="none" d="M20.397,17.652v3.408c0,0.305-0.102,0.746-0.398,0.746H0.623c-0.29,0-0.447-0.445-0.447-0.746v-3.408"></path>
										<path fill="#8C8C8C" d="M10.116,21.75c4.375,0,9.765,0.945,9.765-0.844c0-0.98,1.149-3.814-0.716-5.961
											c-1.546-1.778-5.738-3.007-9.151-3.007c-3.65,0-7.75,1.744-9.098,3.686c-1.434,2.066-0.755,4.359-0.755,5.283
											C0.161,22.695,5.741,21.75,10.116,21.75z"></path>
									</g>
								</svg>
					    	</a>
					    	
{% else %}	
					    	<a href="http://foodtalk.in/app/index.html" class="button-getapp">Get App</a>
<!-- <a href="" class="button-login">Login</a>  -->					    	
							<fb:login-button class="login" scope="public_profile,email" onlogin="checkLoginState();" size="large" ></fb:login-button>
					    								
					    								<script>
  // This is called with the results from from FB.getLoginStatus().
  function statusChangeCallback(response) {
    console.log('statusChangeCallback');
    console.log(response);
    // The response object is returned with a status field that lets the
    // app know the current login status of the person.
    // Full docs on the response object can be found in the documentation
    // for FB.getLoginStatus().
    if (response.status === 'connected') {
      // Logged into your app and Facebook.
      testAPI();
    } else if (response.status === 'not_authorized') {
      // The person is logged into Facebook, but not your app.
      document.getElementById('status').innerHTML = 'Please log ' +
        'into this app.';
    } else {
      // The person is not logged into Facebook, so we're not sure if
      // they are logged into this app or not.
      document.getElementById('status').innerHTML = 'Please log ' +
        'into Facebook.';
    }
  }

  // This function is called when someone finishes with the Login
  // Button.  See the onlogin handler attached to it in the sample
  // code below.
  function checkLoginState() {
    FB.getLoginStatus(function(response) {
      statusChangeCallback(response);
    });
  }

  window.fbAsyncInit = function() {
  FB.init({
    appId      : '567830766693152',
    cookie     : true,  // enable cookies to allow the server to access 
                        // the session
    xfbml      : true,  // parse social plugins on this page
    version    : 'v2.5' // use graph api version 2.5
  });

  // Now that we've initialized the JavaScript SDK, we call 
  // FB.getLoginStatus().  This function gets the state of the
  // person visiting this page and can return one of three states to
  // the callback you provide.  They can be:
  //
  // 1. Logged into your app ('connected')
  // 2. Logged into Facebook, but not your app ('not_authorized')
  // 3. Not logged into Facebook and can't tell if they are logged into
  //    your app or not.
  //
  // These three cases are handled in the callback function.

//  FB.getLoginStatus(function(response) {
//    statusChangeCallback(response);
//  });

  };

  // Load the SDK asynchronously
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));

  // Here we run a very simple test of the Graph API after login is
  // successful.  See statusChangeCallback() for when this call is made.
  function testAPI() {
    console.log('Welcome!  Fetching your information.... ');

	  FB.api('/me',{ locale: 'en_US', fields: 'gender,birthday, name, email' }, function(response) {

      if(!response.hasOwnProperty('email')){
  	  	revoke_permission(response.id);
      }
      
      var postData = { fullName: response.name, email: response.email, gender: response.gender, facebookId: response.id   }
      
//      if($('#userName').val().length>2){
//   	  postData.userName = $('#userName').val(); 
//    }
//      if($('#email').val().length>2){
//    	  postData.email = $('#email').val(); 
//      }

      
      
//      console.log('postData : ');
//      console.log(postData);
      
      $.post( "/login", postData )
      .done(function( data ) {
			console.log(data);
			window.location.replace('/redirect')
      });

      
    });
  }
  
  function revoke_permission(fbid) {
	  var apipath = '/'+fbid+'/permissions';
	  FB.api(apipath, function(response) {
	      
	      $.each(response.data, function(index, value){
	    	  
	    	  if(value.permission == "email"){
	    		  if(value.status == "granted"){	    			  
	    			  $('#email').show();
	    		  }
	    		  else{
	    			 // revoke permission 
	    			  FB.api(apipath,'delete', function(response) {});	    			  
	    			  alert('Please allow foodtalk to access your facebook email');
	    		  }
	    	  }
	      });
	      
	    });
  }
  
</script>
{% endif %}

					    								
					    </div>
					    
					 </div>
				    
				</div>
			</nav>
{% endblock %}
{% block body %}
<div class="container" style="margin-top: 100px;">
	<div class="row" id="posts">
	{% block profile %}{% endblock %}
	{% block postcontainer %}{% endblock %}
	</div>
	<div id="loading"  class="center" style="display: none;">Loading....</div>
		<div id="stoploading"  class="center" style="display: none;">No more dishes</div>
</div>
{% endblock %}
{% block footer %}{% endblock %}			
		</div>
		<!-- jquery -->

		<script>
			function urlParam(name){
				var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
				try{
					return results[1];		
				}catch(e){
//					console.log(e);
					return false;
				}
			}
			function checkLogin(event){
				if(!isLogedin){
					event.preventDefault();
					$('#myModal').modal('show');
					throw "you need to login";
				}
				return true;
			}
		</script>
		
		<script type="text/javascript" src="http://arrow.scrolltotop.com/arrow27.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	</body>
</html>
{% endspaceless %}